/**
 * VERIFY SCHEMA FIX
 * 
 * Quick verification that the schema migration fixed all the errors
 */

const { chromium } = require('playwright');

async function verifyFix() {
  const browser = await chromium.launch({ headless: false });
  const page = await browser.newPage();

  // Capture console errors
  const errors = [];
  page.on('console', msg => {
    if (msg.type() === 'error') {
      errors.push({
        text: msg.text(),
        location: msg.location()
      });
    }
  });

  try {
    console.log('\nüîç VERIFYING SCHEMA FIX');
    console.log('='.repeat(80));

    // Login
    console.log('\nüîê Logging in...');
    await page.goto('http://localhost:3004/login');
    await page.fill('input[type="email"]', 'owner@company.com');
    await page.fill('input[type="password"]', 'password123');
    await page.click('button[type="submit"]');
    await page.waitForURL('**/dashboard', { timeout: 10000 });
    console.log('‚úÖ Logged in\n');

    // Test Company Profile Settings
    console.log('üìã Testing Company Profile Settings...');
    await page.goto('http://localhost:3004/settings?tab=company');
    await page.waitForTimeout(2000);
    
    const companyErrors = errors.filter(e => 
      e.text.includes('licenses') || 
      e.text.includes('company')
    );
    
    if (companyErrors.length === 0) {
      console.log('‚úÖ Company Profile: No errors!');
    } else {
      console.log(`‚ùå Company Profile: ${companyErrors.length} errors`);
      companyErrors.forEach(e => console.log(`   - ${e.text}`));
    }

    // Test Rate Cards Settings
    console.log('\nüìã Testing Rate Cards Settings...');
    errors.length = 0; // Clear errors
    await page.goto('http://localhost:3004/settings?tab=rate-cards');
    await page.waitForTimeout(2000);
    
    const rateCardErrors = errors.filter(e => 
      e.text.includes('service_name') || 
      e.text.includes('rate_cards') ||
      e.text.includes('sort_order')
    );
    
    if (rateCardErrors.length === 0) {
      console.log('‚úÖ Rate Cards: No errors!');
    } else {
      console.log(`‚ùå Rate Cards: ${rateCardErrors.length} errors`);
      rateCardErrors.forEach(e => console.log(`   - ${e.text}`));
    }

    // Test Smart Scheduling Settings
    console.log('\nüìã Testing Smart Scheduling Settings...');
    errors.length = 0; // Clear errors
    await page.goto('http://localhost:3004/settings?tab=scheduling');
    await page.waitForTimeout(2000);
    
    const schedulingErrors = errors.filter(e => 
      e.text.includes('buffer') || 
      e.text.includes('business_hours') ||
      e.text.includes('scheduling')
    );
    
    if (schedulingErrors.length === 0) {
      console.log('‚úÖ Smart Scheduling: No errors!');
    } else {
      console.log(`‚ùå Smart Scheduling: ${schedulingErrors.length} errors`);
      schedulingErrors.forEach(e => console.log(`   - ${e.text}`));
    }

    // Summary
    console.log('\n' + '='.repeat(80));
    console.log('üìä VERIFICATION SUMMARY');
    console.log('='.repeat(80));
    
    const totalErrors = companyErrors.length + rateCardErrors.length + schedulingErrors.length;
    
    if (totalErrors === 0) {
      console.log('\nüéâ SUCCESS! All schema drift issues are FIXED!');
      console.log('\n‚úÖ Company Profile Settings: Working');
      console.log('‚úÖ Rate Cards Settings: Working');
      console.log('‚úÖ Smart Scheduling Settings: Working');
    } else {
      console.log(`\n‚ö†Ô∏è  Still have ${totalErrors} errors to fix`);
    }

    console.log('\nüöÄ NEXT: Rebuild the app to see all fixes take effect!');
    console.log('   Ctrl+C then npm start\n');

    // Keep browser open for inspection
    console.log('Browser will stay open for 15 seconds for manual inspection...\n');
    await page.waitForTimeout(15000);

  } catch (error) {
    console.error('\n‚ùå ERROR:', error.message);
  } finally {
    await browser.close();
  }
}

verifyFix();

