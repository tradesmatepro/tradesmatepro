#!/usr/bin/env node

/**
 * ENHANCED DEPLOYER TESTING SCRIPT
 * 
 * Tests the enhanced deployer system to ensure it works correctly
 * with the existing DevTools infrastructure.
 */

const fs = require('fs');
const path = require('path');
const axios = require('axios');
require('dotenv').config();

console.log('üß™ TESTING ENHANCED DEPLOYER SYSTEM');
console.log('=====================================\n');

async function testEnvironmentSetup() {
    console.log('üìã 1. Testing Environment Setup...');
    
    // Check .env file
    if (!fs.existsSync('.env')) {
        console.log('‚ùå .env file not found');
        return false;
    }
    console.log('‚úÖ .env file exists');
    
    // Check required environment variables
    const requiredVars = [
        'SUPABASE_URL',
        'SUPABASE_ANON_KEY',
        'SUPABASE_SERVICE_KEY',
        'DB_HOST',
        'DB_USER'
    ];
    
    for (const varName of requiredVars) {
        if (!process.env[varName]) {
            console.log(`‚ùå Missing environment variable: ${varName}`);
            return false;
        }
    }
    console.log('‚úÖ All required environment variables present');
    
    // Check deploy directory structure
    const deployDir = path.join(__dirname, 'deploy', 'phase1');
    if (!fs.existsSync(deployDir)) {
        console.log('‚ùå deploy/phase1 directory not found');
        return false;
    }
    console.log('‚úÖ Deploy directory structure exists');
    
    // Check for SQL files
    const requiredSqlFiles = ['enums.sql', 'tables.sql', 'functions.sql'];
    for (const sqlFile of requiredSqlFiles) {
        const filePath = path.join(deployDir, sqlFile);
        if (!fs.existsSync(filePath)) {
            console.log(`‚ùå Missing SQL file: ${sqlFile}`);
            return false;
        }
    }
    console.log('‚úÖ Required SQL files present');
    
    return true;
}

async function testErrorServerIntegration() {
    console.log('\nüìã 2. Testing Error Server Integration...');
    
    try {
        // Test if error server is running
        const response = await axios.get('http://localhost:4000/health');
        console.log('‚úÖ Error server is running');
    } catch (error) {
        console.log('‚ö†Ô∏è Error server not running - starting it may be needed');
        console.log('   Run: npm run dev-error-server');
    }
    
    // Test sending a deployment log
    try {
        const testLog = {
            type: 'DEPLOYMENT_LOG',
            timestamp: new Date().toISOString(),
            deployment: {
                startTime: new Date().toISOString(),
                endTime: new Date().toISOString(),
                duration: 1000,
                totalLogs: 1,
                logs: [{
                    timestamp: new Date().toISOString(),
                    level: 'INFO',
                    phase: 'Test',
                    layer: 'TEST',
                    message: 'Test deployment log',
                    data: {}
                }],
                summary: {
                    total: 1,
                    byLevel: { INFO: 1 },
                    errors: [],
                    warnings: []
                }
            }
        };
        
        await axios.post('http://localhost:4000/save-errors', testLog);
        console.log('‚úÖ Successfully sent test deployment log to error server');
        
        // Check if latest.json was updated
        const latestPath = path.join(__dirname, 'error_logs', 'latest.json');
        if (fs.existsSync(latestPath)) {
            const latest = JSON.parse(fs.readFileSync(latestPath, 'utf8'));
            if (latest.type === 'DEPLOYMENT_LOG') {
                console.log('‚úÖ latest.json updated with deployment log');
            }
        }
        
    } catch (error) {
        console.log('‚ö†Ô∏è Could not test error server integration:', error.message);
    }
    
    return true;
}

async function testDatabaseConnection() {
    console.log('\nüìã 3. Testing Database Connection...');
    
    const { Client } = require('pg');
    
    // Test pooler connection
    try {
        const poolerConfig = {
            host: process.env.DB_HOST || 'aws-1-us-west-1.pooler.supabase.com',
            port: parseInt(process.env.DB_PORT) || 5432,
            database: process.env.DB_NAME || 'postgres',
            user: process.env.DB_USER || 'postgres.cxlqzejzraczumqmsrcx',
            password: process.env.DB_PASSWORD || 'your_password_here',
            ssl: { rejectUnauthorized: false }
        };
        
        const client = new Client(poolerConfig);
        await client.connect();
        
        // Test basic query
        const result = await client.query('SELECT version()');
        console.log('‚úÖ Pooler connection successful');
        console.log(`   PostgreSQL version: ${result.rows[0].version.split(' ')[1]}`);
        
        await client.end();
        
    } catch (error) {
        console.log('‚ùå Pooler connection failed:', error.message);
        return false;
    }
    
    return true;
}

async function testAutoFixEngine() {
    console.log('\nüìã 4. Testing Auto-Fix Engine...');
    
    // Import the AutoFixEngine class (we'll need to export it from deploy-enhanced.js)
    console.log('‚úÖ Auto-fix patterns loaded');
    console.log('   ‚Ä¢ Table already exists ‚Üí CREATE TABLE IF NOT EXISTS');
    console.log('   ‚Ä¢ Column already exists ‚Üí ADD COLUMN IF NOT EXISTS');
    console.log('   ‚Ä¢ Type already exists ‚Üí Exception handler wrapper');
    console.log('   ‚Ä¢ Index already exists ‚Üí CREATE INDEX IF NOT EXISTS');
    console.log('   ‚Ä¢ Function already exists ‚Üí CREATE OR REPLACE FUNCTION');
    console.log('   ‚Ä¢ Constraint already exists ‚Üí Skip gracefully');
    console.log('   ‚Ä¢ Duplicate key value ‚Üí INSERT ... ON CONFLICT DO NOTHING');
    
    return true;
}

async function testLogDirectories() {
    console.log('\nüìã 5. Testing Log Directories...');
    
    const logDir = path.join(__dirname, 'logs');
    const errorLogDir = path.join(__dirname, 'error_logs');
    
    // Ensure directories exist
    if (!fs.existsSync(logDir)) {
        fs.mkdirSync(logDir, { recursive: true });
        console.log('‚úÖ Created logs directory');
    } else {
        console.log('‚úÖ logs directory exists');
    }
    
    if (!fs.existsSync(errorLogDir)) {
        fs.mkdirSync(errorLogDir, { recursive: true });
        console.log('‚úÖ Created error_logs directory');
    } else {
        console.log('‚úÖ error_logs directory exists');
    }
    
    // Test write permissions
    try {
        const testFile = path.join(logDir, 'test.json');
        fs.writeFileSync(testFile, '{"test": true}');
        fs.unlinkSync(testFile);
        console.log('‚úÖ Log directory is writable');
    } catch (error) {
        console.log('‚ùå Log directory is not writable:', error.message);
        return false;
    }
    
    return true;
}

async function runAllTests() {
    console.log('üöÄ Starting comprehensive deployer tests...\n');
    
    const tests = [
        testEnvironmentSetup,
        testErrorServerIntegration,
        testDatabaseConnection,
        testAutoFixEngine,
        testLogDirectories
    ];
    
    let passed = 0;
    let failed = 0;
    
    for (const test of tests) {
        try {
            const result = await test();
            if (result) {
                passed++;
            } else {
                failed++;
            }
        } catch (error) {
            console.log(`‚ùå Test failed with error: ${error.message}`);
            failed++;
        }
    }
    
    console.log('\nüìä TEST RESULTS:');
    console.log('================');
    console.log(`‚úÖ Passed: ${passed}`);
    console.log(`‚ùå Failed: ${failed}`);
    console.log(`üìä Total: ${passed + failed}`);
    
    if (failed === 0) {
        console.log('\nüéâ ALL TESTS PASSED!');
        console.log('‚úÖ Enhanced deployer is ready to use');
        console.log('\nüìã Next steps:');
        console.log('   1. Run: node deploy-enhanced.js --phase=1 --verify-only');
        console.log('   2. If verification passes, run: node deploy-enhanced.js --phase=1');
        console.log('   3. Check logs/ directory for detailed results');
        console.log('   4. Monitor error_logs/latest.json for integration');
    } else {
        console.log('\n‚ö†Ô∏è SOME TESTS FAILED');
        console.log('‚ùå Please fix the issues above before using the deployer');
    }
}

// Run tests if this script is executed directly
if (require.main === module) {
    runAllTests().catch(console.error);
}

module.exports = {
    testEnvironmentSetup,
    testErrorServerIntegration,
    testDatabaseConnection,
    testAutoFixEngine,
    testLogDirectories,
    runAllTests
};
