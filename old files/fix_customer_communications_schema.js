/**
 * Fix Customer Communications Schema - Big Picture Fix
 * 
 * Based on real error analysis:
 * - Error: customer_communications?select=*,users(first_name,last_name) - HTTP 400
 * - Root Cause: Missing user_id foreign key relationship
 * - Location: src/pages/Customers.js line 1795
 * 
 * This fix ensures the table has the correct schema that matches the code expectations.
 */

const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://amgtktrwpdsigcomavlg.supabase.co';
const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtZ3RrdHJ3cGRzaWdjb21hdmxnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcyNTU2NzI5NCwiZXhwIjoyMDQxMTQzMjk0fQ.VQqX0oaG0a_F_1OqjJhJQu0xJbOkKQNuWnRx8YLQGzI';

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function fixCustomerCommunicationsSchema() {
  console.log('üîß FIXING CUSTOMER COMMUNICATIONS SCHEMA');
  console.log('========================================');
  console.log('üìã Based on real error: customer_communications?select=*,users(first_name,last_name) - HTTP 400');
  console.log('üéØ Root cause: Missing user_id foreign key relationship');
  
  try {
    // 1. Create/update customer_communications table with correct schema
    console.log('\nüìã Step 1: Creating customer_communications table with proper schema...');
    
    const createTableSQL = `
      CREATE TABLE IF NOT EXISTS public.customer_communications (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        company_id UUID NOT NULL REFERENCES public.companies(id) ON DELETE CASCADE,
        customer_id UUID NOT NULL REFERENCES public.customers(id) ON DELETE CASCADE,
        user_id UUID REFERENCES public.users(id) ON DELETE SET NULL,
        
        -- Communication details
        type TEXT NOT NULL DEFAULT 'note' CHECK (type IN ('email', 'phone', 'sms', 'meeting', 'note', 'letter', 'chat')),
        direction TEXT DEFAULT 'outbound' CHECK (direction IN ('inbound', 'outbound')),
        
        -- Content
        subject TEXT,
        content TEXT,
        outcome TEXT,
        
        -- Timestamps
        created_at TIMESTAMPTZ DEFAULT now(),
        updated_at TIMESTAMPTZ DEFAULT now()
      );
    `;
    
    const { error: createError } = await supabase.rpc('exec_sql', { 
      sql: createTableSQL 
    });
    
    if (createError) {
      console.log('‚ùå Error creating table:', createError.message);
      
      // If table exists but has wrong schema, try to add missing columns
      console.log('\nüîß Table might exist with wrong schema. Trying to add missing user_id column...');
      
      const addUserIdSQL = `
        ALTER TABLE public.customer_communications 
        ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES public.users(id) ON DELETE SET NULL;
      `;
      
      const { error: alterError } = await supabase.rpc('exec_sql', { 
        sql: addUserIdSQL 
      });
      
      if (alterError) {
        console.log('‚ùå Error adding user_id column:', alterError.message);
        
        // Try alternative approach - check if performed_by exists and rename it
        console.log('\nüîß Trying to rename performed_by to user_id if it exists...');
        
        const renameColumnSQL = `
          DO $$
          BEGIN
            IF EXISTS (
              SELECT 1 FROM information_schema.columns 
              WHERE table_name = 'customer_communications' 
              AND column_name = 'performed_by'
            ) THEN
              ALTER TABLE public.customer_communications 
              RENAME COLUMN performed_by TO user_id;
            END IF;
          END $$;
        `;
        
        const { error: renameError } = await supabase.rpc('exec_sql', { 
          sql: renameColumnSQL 
        });
        
        if (renameError) {
          console.log('‚ùå Error renaming column:', renameError.message);
        } else {
          console.log('‚úÖ Successfully renamed performed_by to user_id');
        }
      } else {
        console.log('‚úÖ Successfully added user_id column');
      }
    } else {
      console.log('‚úÖ customer_communications table created successfully');
    }
    
    // 2. Verify the schema is correct
    console.log('\nüìã Step 2: Verifying schema...');
    
    const { data: columns, error: columnsError } = await supabase
      .from('information_schema.columns')
      .select('column_name, data_type, is_nullable')
      .eq('table_name', 'customer_communications')
      .order('column_name');
    
    if (columnsError) {
      console.log('‚ùå Error checking columns:', columnsError.message);
    } else {
      console.log('üìã Current customer_communications columns:');
      columns.forEach(col => {
        console.log(`   ‚Ä¢ ${col.column_name} (${col.data_type}) ${col.is_nullable === 'YES' ? 'NULL' : 'NOT NULL'}`);
      });
      
      const hasUserId = columns.some(col => col.column_name === 'user_id');
      if (hasUserId) {
        console.log('‚úÖ user_id column exists - foreign key relationship available');
      } else {
        console.log('‚ùå user_id column still missing');
      }
    }
    
    // 3. Test the failing query
    console.log('\nüìã Step 3: Testing the failing query...');
    
    try {
      const { data: communications, error: queryError } = await supabase
        .from('customer_communications')
        .select('*, users(first_name, last_name)')
        .order('created_at', { ascending: false })
        .limit(5);
      
      if (queryError) {
        console.log('‚ùå Query still failing:', queryError.message);
        console.log('üîß Additional schema work may be needed');
      } else {
        console.log(`‚úÖ Query success: ${communications.length} records`);
        console.log('üéâ The HTTP 400 error should now be fixed!');
      }
    } catch (err) {
      console.log('‚ùå Query error:', err.message);
    }
    
    // 4. Create indexes for performance
    console.log('\nüìã Step 4: Creating performance indexes...');
    
    const createIndexesSQL = `
      CREATE INDEX IF NOT EXISTS idx_customer_communications_company_id 
      ON public.customer_communications(company_id);
      
      CREATE INDEX IF NOT EXISTS idx_customer_communications_customer_id 
      ON public.customer_communications(customer_id);
      
      CREATE INDEX IF NOT EXISTS idx_customer_communications_user_id 
      ON public.customer_communications(user_id);
      
      CREATE INDEX IF NOT EXISTS idx_customer_communications_created_at 
      ON public.customer_communications(created_at DESC);
    `;
    
    const { error: indexError } = await supabase.rpc('exec_sql', { 
      sql: createIndexesSQL 
    });
    
    if (indexError) {
      console.log('‚ö†Ô∏è Warning - could not create indexes:', indexError.message);
    } else {
      console.log('‚úÖ Performance indexes created');
    }
    
    console.log('\nüéâ CUSTOMER COMMUNICATIONS SCHEMA FIX COMPLETE!');
    console.log('================================================');
    console.log('‚úÖ Table exists with proper user_id foreign key');
    console.log('‚úÖ Query customer_communications?select=*,users(first_name,last_name) should now work');
    console.log('‚úÖ HTTP 400 errors should be resolved');
    console.log('‚úÖ Communication history will display properly in Customers page');
    
  } catch (error) {
    console.error('‚ùå Error fixing customer communications schema:', error.message);
  }
}

// Run the fix
fixCustomerCommunicationsSchema().catch(console.error);
