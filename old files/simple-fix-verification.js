const http = require('http');
const fs = require('fs');
const path = require('path');

async function verifyAppRunning() {
  return new Promise((resolve) => {
    const req = http.get('http://localhost:3003', (res) => {
      if (res.statusCode === 200) {
        resolve(true);
      } else {
        resolve(false);
      }
    });
    
    req.on('error', () => {
      resolve(false);
    });
    
    req.setTimeout(5000, () => {
      req.destroy();
      resolve(false);
    });
  });
}

function verifyCodeFixes() {
  console.log('üîç Verifying code fixes...');
  
  // Check InlineResponseForm.js for the fixes
  const inlineResponseFormPath = path.join(__dirname, 'src', 'components', 'Marketplace', 'InlineResponseForm.js');
  
  if (!fs.existsSync(inlineResponseFormPath)) {
    console.log('‚ùå InlineResponseForm.js not found');
    return false;
  }
  
  const content = fs.readFileSync(inlineResponseFormPath, 'utf8');
  
  // Check for onAvailabilitySelect fix
  const hasOnAvailabilitySelect = content.includes('onAvailabilitySelect={(availability)');
  const hasCorrectColumnNames = content.includes('response_status:') && 
                                content.includes('available_start:') && 
                                content.includes('available_end:');
  
  if (hasOnAvailabilitySelect) {
    console.log('‚úÖ SmartAvailabilityPicker onAvailabilitySelect prop fix verified');
  } else {
    console.log('‚ùå SmartAvailabilityPicker onAvailabilitySelect prop fix not found');
    return false;
  }
  
  if (hasCorrectColumnNames) {
    console.log('‚úÖ Database column names fix verified (response_status, available_start, available_end)');
  } else {
    console.log('‚ùå Database column names fix not found');
    return false;
  }
  
  return true;
}

function verifyDependencies() {
  console.log('üîç Verifying dependencies...');
  
  const packageJsonPath = path.join(__dirname, 'package.json');
  const nodeModulesPath = path.join(__dirname, 'node_modules');
  
  if (!fs.existsSync(packageJsonPath)) {
    console.log('‚ùå package.json not found');
    return false;
  }
  
  if (!fs.existsSync(nodeModulesPath)) {
    console.log('‚ùå node_modules not found');
    return false;
  }
  
  // Check for recharts
  const rechartsPath = path.join(nodeModulesPath, 'recharts');
  const fullcalendarPath = path.join(nodeModulesPath, '@fullcalendar');
  
  if (fs.existsSync(rechartsPath)) {
    console.log('‚úÖ recharts dependency installed');
  } else {
    console.log('‚ùå recharts dependency missing');
    return false;
  }
  
  if (fs.existsSync(fullcalendarPath)) {
    console.log('‚úÖ @fullcalendar dependencies installed');
  } else {
    console.log('‚ùå @fullcalendar dependencies missing');
    return false;
  }
  
  return true;
}

async function runVerification() {
  console.log('üöÄ Starting automated fix verification...\n');
  
  // 1. Verify dependencies
  const depsOk = verifyDependencies();
  
  // 2. Verify code fixes
  const fixesOk = verifyCodeFixes();
  
  // 3. Verify app is running
  console.log('üîç Checking if app is running...');
  const appRunning = await verifyAppRunning();
  
  if (appRunning) {
    console.log('‚úÖ App is running successfully on port 3003');
  } else {
    console.log('‚ùå App is not running or not responding');
  }
  
  // Summary
  console.log('\n' + '='.repeat(50));
  console.log('üìã VERIFICATION SUMMARY');
  console.log('='.repeat(50));
  
  if (depsOk && fixesOk && appRunning) {
    console.log('üéâ ALL VERIFICATIONS PASSED!');
    console.log('‚úÖ Dependencies installed correctly');
    console.log('‚úÖ Code fixes applied correctly');
    console.log('‚úÖ App is running without compilation errors');
    console.log('');
    console.log('üöÄ FIXES SUCCESSFULLY APPLIED:');
    console.log('   ‚Ä¢ SmartAvailabilityPicker onAvailabilitySelect error - FIXED');
    console.log('   ‚Ä¢ Database column mismatch (response_type) error - FIXED');
    console.log('   ‚Ä¢ Missing dependencies (recharts, @fullcalendar) - FIXED');
    console.log('');
    console.log('‚ú® The marketplace response system should now work correctly!');
    console.log('üß™ You can now test responding to the "cake needed" job as jerry@jerrysflowers.com');
    return true;
  } else {
    console.log('‚ùå SOME VERIFICATIONS FAILED');
    console.log(`Dependencies: ${depsOk ? '‚úÖ' : '‚ùå'}`);
    console.log(`Code Fixes: ${fixesOk ? '‚úÖ' : '‚ùå'}`);
    console.log(`App Running: ${appRunning ? '‚úÖ' : '‚ùå'}`);
    return false;
  }
}

// Run the verification
runVerification().then(success => {
  process.exit(success ? 0 : 1);
}).catch(error => {
  console.error('‚ùå Verification failed:', error);
  process.exit(1);
});
