const puppeteer = require('puppeteer');

async function testFixesSimple() {
    console.log('üöÄ TESTING COMPILATION FIXES AND SESSION PERSISTENCE');
    console.log('=' .repeat(60));

    let browser;
    try {
        browser = await puppeteer.launch({ 
            headless: false,
            defaultViewport: null,
            args: ['--start-maximized']
        });
        
        const page = await browser.newPage();
        
        // Monitor console logs for compilation errors and session behavior
        const consoleLogs = [];
        page.on('console', msg => {
            const text = msg.text();
            consoleLogs.push(text);
            
            // Log important messages
            if (text.includes('üîß') || 
                text.includes('‚úÖ') || 
                text.includes('üßπ') || 
                text.includes('cbrown') ||
                text.includes('ERROR') ||
                text.includes('Cleared any persisted sessions') ||
                text.includes('Loading customer data')) {
                console.log(`   üìä ${text}`);
            }
        });

        // Monitor page errors (compilation issues)
        page.on('pageerror', error => {
            console.log(`   üî¥ PAGE ERROR: ${error.message}`);
        });

        console.log('\nüìã TEST 1: LOADING APP AND CHECKING FOR COMPILATION ERRORS');
        
        // Try to find the running app
        const ports = [3000, 3001, 3002, 3003];
        let workingPort = null;
        
        for (const port of ports) {
            try {
                console.log(`   üîß Trying port ${port}...`);
                await page.goto(`http://localhost:${port}`, { 
                    waitUntil: 'domcontentloaded',
                    timeout: 5000 
                });
                
                const hasCustomerPortal = await page.evaluate(() => {
                    return document.body.textContent.includes('Customer Portal') ||
                           document.body.textContent.includes('Magic Link') ||
                           document.body.textContent.includes('You need to enable JavaScript');
                });
                
                if (hasCustomerPortal) {
                    workingPort = port;
                    console.log(`   ‚úÖ Found Customer Portal on port ${port}`);
                    break;
                }
            } catch (error) {
                console.log(`   ‚ùå Port ${port} not accessible`);
            }
        }
        
        if (!workingPort) {
            console.log('   ‚ùå Could not find running Customer Portal');
            console.log('   üìã Make sure to run: cd "Customer Portal" && npm start');
            return;
        }

        console.log('\nüìã TEST 2: CHECKING FOR COMPILATION ERRORS');
        
        // Wait for React to load and check for errors
        await new Promise(resolve => setTimeout(resolve, 5000));
        
        // Check if the page loaded successfully (no compilation errors)
        const pageContent = await page.evaluate(() => {
            return {
                hasJavaScriptError: document.body.textContent.includes('You need to enable JavaScript'),
                hasReactApp: !!window.React || document.body.textContent.includes('Customer Portal'),
                bodyText: document.body.textContent.substring(0, 200),
                currentPath: window.location.pathname
            };
        });
        
        console.log(`   üìä Has JavaScript Error: ${pageContent.hasJavaScriptError ? '‚ùå YES' : '‚úÖ NO'}`);
        console.log(`   üìä React App Loaded: ${pageContent.hasReactApp ? '‚úÖ YES' : '‚ùå NO'}`);
        console.log(`   üìä Current Path: ${pageContent.currentPath}`);
        
        if (!pageContent.hasJavaScriptError && pageContent.hasReactApp) {
            console.log('   ‚úÖ SUCCESS: App compiled and loaded without errors');
        } else {
            console.log('   ‚ùå COMPILATION ISSUES: App not loading properly');
        }

        console.log('\nüìã TEST 3: CHECKING SESSION PERSISTENCE');
        
        // Check for fake user persistence
        const hasFakeUser = await page.evaluate(() => {
            return document.body.textContent.includes('cbrown@cgrenewables.com');
        });
        
        console.log(`   üìä Has fake user on load: ${hasFakeUser ? '‚ùå YES' : '‚úÖ NO'}`);
        
        // Check console logs for session clearing
        const hasSessionClearing = consoleLogs.some(log => 
            log.includes('Cleared any persisted sessions') || 
            log.includes('üßπ')
        );
        
        console.log(`   üìä Session clearing detected: ${hasSessionClearing ? '‚úÖ YES' : '‚ùå NO'}`);
        
        // Test refresh behavior
        console.log('   üîß Testing refresh behavior...');
        await page.reload({ waitUntil: 'domcontentloaded' });
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        const afterRefreshHasFakeUser = await page.evaluate(() => {
            return document.body.textContent.includes('cbrown@cgrenewables.com');
        });
        
        console.log(`   üìä Has fake user after refresh: ${afterRefreshHasFakeUser ? '‚ùå YES' : '‚úÖ NO'}`);

        console.log('\nüìã FINAL RESULTS:');
        console.log('=' .repeat(50));
        
        const compilationFixed = !pageContent.hasJavaScriptError && pageContent.hasReactApp;
        const sessionPersistenceFixed = !hasFakeUser && !afterRefreshHasFakeUser;
        
        console.log(`‚úÖ Compilation Errors Fixed: ${compilationFixed ? 'YES' : 'NO'}`);
        console.log(`‚úÖ Session Persistence Fixed: ${sessionPersistenceFixed ? 'YES' : 'NO'}`);
        
        if (compilationFixed && sessionPersistenceFixed) {
            console.log('\nüéâ ALL FIXES SUCCESSFUL!');
            console.log('   ‚Ä¢ App compiles without errors');
            console.log('   ‚Ä¢ No fake user persistence');
            console.log('   ‚Ä¢ Clean login experience');
        } else {
            console.log('\n‚ö†Ô∏è  SOME ISSUES REMAIN:');
            if (!compilationFixed) {
                console.log('   ‚Ä¢ Compilation errors still present');
            }
            if (!sessionPersistenceFixed) {
                console.log('   ‚Ä¢ Fake user still persisting');
            }
        }
        
        console.log('\nüìã Keeping browser open for 10 seconds for manual verification...');
        await new Promise(resolve => setTimeout(resolve, 10000));
        
    } catch (error) {
        console.log('‚ùå Test failed:', error.message);
    } finally {
        if (browser) {
            await browser.close();
        }
    }
}

testFixesSimple().catch(console.error);
