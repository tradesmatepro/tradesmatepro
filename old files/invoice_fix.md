🔧 Frontend Changes (Claude must implement)
1. Company Setup / Settings Page

Add fields in company settings UI for:

Invoice Prefix (companies.invoice_prefix)

Invoice Start Number (companies.invoice_start_number)

Default prefix can be the current year (2025-), but user can change it.

Default start number is 1, but user can set it to another (e.g., 100) if migrating from another system.

These values must be saved to the companies table.

2. Invoice Creation

When creating a new invoice:

DO NOT generate invoice_number in the frontend.

Send request with basic invoice data (company_id, work_order_id, customer_id, total_amount, etc.).

Backend trigger (set_invoice_number) will automatically set the invoice_number.

The API/DB response will include the final invoice_number. The frontend must:

Capture this returned value.

Display it immediately in the invoice view (e.g., “Invoice #2025-001”).

3. Invoice Display

Always show the invoice_number returned by the backend, not something computed in the app.

If invoices are edited or updated later, do not overwrite invoice_number — it should remain fixed once set.

4. Migrations / Edge Cases

If a company already has invoices:

Make sure companies.invoice_start_number is set higher than the last issued invoice, otherwise duplicates will occur.

Claude must handle this in the migration/setup screen.

5. Validation

Before allowing an invoice to be created:

Ensure company.invoice_prefix is set (default if empty).

Ensure company.invoice_start_number is set (default if empty).

If not, prompt admin to configure company invoice settings first.

🔍 Summary for Claude

Stop assigning invoice_number in the app. It’s generated by the database.

Expose company invoice settings (prefix + start number) in the company setup page.

Update API calls so that invoice creation returns the DB-generated number, which must be shown in the UI.

Handle migrations by adjusting invoice_start_number so new invoices don’t conflict.

Never allow frontend edits of invoice_number after creation — only prefix/start_number in company settings affect future invoices.

👉 That’s the whole flow. No ambiguity. Backend is source of truth for numbering.

Exactly 👍 — let’s take out all the guessing for Claude.
Here are the precise SQL queries / Supabase API calls he should use when reading and updating invoice prefix & start number.

🧾 Reading Invoice Settings (per company)

SQL

SELECT invoice_prefix, invoice_start_number
FROM public.companies
WHERE id = 'COMPANY_UUID';


Supabase JS

const { data, error } = await supabase
  .from('companies')
  .select('invoice_prefix, invoice_start_number')
  .eq('id', companyId)
  .single();

✏️ Updating Invoice Settings (per company)

SQL

UPDATE public.companies
SET invoice_prefix = '2025-',
    invoice_start_number = 100
WHERE id = 'COMPANY_UUID';


Supabase JS

const { data, error } = await supabase
  .from('companies')
  .update({
    invoice_prefix: '2025-',
    invoice_start_number: 100
  })
  .eq('id', companyId)
  .select();

📦 Creating an Invoice (uses backend trigger)

SQL

INSERT INTO public.invoices (company_id, work_order_id, customer_id, total_amount)
VALUES ('COMPANY_UUID', 'WORK_ORDER_UUID', 'CUSTOMER_UUID', 250.00)
RETURNING invoice_number, status, total_amount;


Supabase JS

const { data, error } = await supabase
  .from('invoices')
  .insert([{
    company_id: companyId,
    work_order_id: workOrderId,
    customer_id: customerId,
    total_amount: 250.00
  }])
  .select('id, invoice_number, status, total_amount')
  .single();

✅ Frontend Rules (Claude must follow)

Never generate invoice_number in frontend → always use DB response.

Expose settings UI → invoice_prefix + invoice_start_number editable under company settings.

When invoice settings change → update companies row, not invoices directly.

On invoice creation → show the number returned by DB immediately (e.g., 2025-001).

⚡ This way the database owns numbering logic (safe for multi-tenant, auditor-friendly), and Claude’s frontend only needs to read & write two fields in companies.