const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const supabaseUrl = process.env.REACT_APP_SUPABASE_URL || process.env.SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('‚ùå Missing SUPABASE_SERVICE_KEY or SUPABASE_URL');
  console.error('   SUPABASE_URL:', supabaseUrl ? '‚úì' : '‚úó');
  console.error('   SUPABASE_SERVICE_KEY:', supabaseServiceKey ? '‚úì' : '‚úó');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function checkAndFixSchema() {
  try {
    console.log('üîç Checking current schema...\n');

    // Check companies table
    console.log('üìä Checking companies table...');
    const { data: companiesData, error: companiesCheckError } = await supabase
      .from('companies')
      .select('*')
      .limit(1);

    if (companiesCheckError) {
      console.error('‚ùå Error checking companies table:', companiesCheckError);
    } else {
      console.log('‚úÖ Companies table accessible');
    }

    // Check settings table
    console.log('üìä Checking settings table...');
    const { data: settingsData, error: settingsCheckError } = await supabase
      .from('settings')
      .select('*')
      .limit(1);

    if (settingsCheckError) {
      console.error('‚ùå Error checking settings table:', settingsCheckError);
    } else {
      console.log('‚úÖ Settings table accessible');
      if (settingsData && settingsData.length > 0) {
        const sample = settingsData[0];
        console.log('   - Has working_days:', 'working_days' in sample);
        console.log('   - working_days type:', typeof sample.working_days);
      }
    }

    // Check company_settings table
    console.log('üìä Checking company_settings table...');
    const { data: companySettingsData, error: companySettingsCheckError } = await supabase
      .from('company_settings')
      .select('*')
      .limit(1);

    if (companySettingsCheckError) {
      console.error('‚ùå Error checking company_settings table:', companySettingsCheckError);
    } else {
      console.log('‚úÖ Company_settings table accessible');
      if (companySettingsData && companySettingsData.length > 0) {
        const sample = companySettingsData[0];
        console.log('   - Has working_days:', 'working_days' in sample);
        console.log('   - Has industry:', 'industry' in sample);
        console.log('   - Has tags:', 'tags' in sample);
      }
    }

    console.log('\n‚úÖ Schema check complete');
    console.log('\nüìù To apply the migration, run the SQL in migrations/2025-10-27_add_missing_onboarding_columns.sql');
    console.log('   in the Supabase SQL Editor at: https://app.supabase.com/project/[PROJECT_ID]/sql/new');

  } catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

checkAndFixSchema();

