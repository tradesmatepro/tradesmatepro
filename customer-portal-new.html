<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Customer Portal - TradeMate Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <!-- Unified Customer Portal: Dashboard + Quote Approval + Deposit + Scheduling + Invoice Payment -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #8b5cf6;
      --accent: #ec4899;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-dark: #0f172a;
      --bg-light: #f8fafc;
      --surface: #ffffff;
      --surface-alt: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-primary);
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: var(--surface);
      border-radius: 20px;
      box-shadow: var(--shadow-xl), 0 0 60px rgba(102, 126, 234, 0.2);
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 50px 40px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    .header h1 {
      font-size: 36px;
      margin-bottom: 12px;
      font-weight: 700;
      letter-spacing: -0.5px;
      position: relative;
      z-index: 1;
    }

    .header p {
      opacity: 0.95;
      font-size: 16px;
      position: relative;
      z-index: 1;
      font-weight: 500;
    }

    .signup-btn {
      position: absolute;
      top: 24px;
      right: 24px;
      background: rgba(255,255,255,0.15);
      color: white;
      border: 1.5px solid rgba(255,255,255,0.3);
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    .signup-btn:hover {
      background: rgba(255,255,255,0.25);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
    }

    .content {
      padding: 50px 40px;
    }

    .loading {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-secondary);
    }

    .spinner {
      border: 3px solid var(--bg-light);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 1px solid #fca5a5;
      color: #991b1b;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: var(--shadow-md);
    }

    /* Modern sections and messages */
    .section-block { background: var(--surface-alt); border-radius: 16px; padding: 24px; border: 1px solid var(--border); box-shadow: var(--shadow-md); }
    .section-block.glass { background: rgba(255,255,255,0.65); backdrop-filter: blur(12px); }
    .section-title { display:flex; justify-content: space-between; align-items: center; margin-bottom: 16px; color: var(--text-primary); font-weight: 700; font-size: 20px; }
    .badge { background: rgba(99,102,241,0.15); color: var(--primary-dark); padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }

    .message-list { margin-bottom: 20px; max-height: 420px; overflow-y: auto; padding-right: 4px; }
    .message-bubble { border-radius: 14px; padding: 14px 16px; margin-bottom: 12px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
    .message-bubble.company { background: linear-gradient(to right, rgba(99,102,241,0.08), rgba(139,92,246,0.08)); border-left: 4px solid var(--primary); }
    .message-bubble.customer { background: linear-gradient(to right, rgba(16,185,129,0.08), rgba(99,102,241,0.05)); border-left: 4px solid var(--success); }
    .message-header { display:flex; justify-content: space-between; margin-bottom: 6px; }
    .sender-name { font-weight: 700; color: var(--text-primary); }
    .message-time { font-size: 12px; color: var(--text-secondary); }
    .message-content { color: #334155; line-height: 1.5; white-space: pre-wrap; }
    .empty-hint { color: var(--text-secondary); }

    .message-compose.card { background: var(--surface); border-radius: 12px; padding: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    .compose-title { margin: 0 0 12px 0; color: var(--text-primary); font-size: 14px; font-weight: 700; }
    .textarea-modern { width: 100%; min-height: 90px; padding: 12px 14px; border: 1px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 14px; resize: vertical; margin-bottom: 12px; background: var(--surface); transition: box-shadow .2s, border-color .2s; }
    .textarea-modern:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99,102,241,0.12); }
    .compose-actions { display:flex; justify-content: space-between; align-items: center; gap: 12px; }
    .compose-hint { color: var(--text-secondary); font-size: 12px; margin: 0; }
    .btn-modern { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: transform .15s ease, box-shadow .2s ease, filter .2s ease; box-shadow: 0 10px 20px rgba(99,102,241,0.25); }
    .btn-modern:hover { transform: translateY(-1px); box-shadow: 0 16px 30px rgba(99,102,241,0.35); filter: saturate(1.1); }
    .btn-modern:disabled { opacity: 0.6; cursor: not-allowed; }


    .timeline {
      margin: 30px 0;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .timeline h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .timeline-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
      position: relative;
      padding-left: 40px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: 12px;
      top: 30px;
      bottom: -20px;
      width: 2px;
      background: #e5e7eb;
    }

    .timeline-item:last-child::before {
      display: none;
    }

    .timeline-icon {
      position: absolute;
      left: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }

    .timeline-icon.completed {
      background: #10b981;
      color: white;
    }

    .timeline-icon.in-progress {
      background: #3b82f6;
      color: white;
    }

    .timeline-icon.pending {
      background: #e5e7eb;
      color: #9ca3af;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .timeline-date {
      font-size: 14px;
      color: #6b7280;
    }

    .project-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .project-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .project-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .status-badge.approved {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.in-progress {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.completed {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.paid {
      background: #d1fae5;
      color: #065f46;
    }

    .project-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
    }

    .detail-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .detail-value {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #1f2937;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .coming-soon-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 12px;
      max-width: 500px;
      text-align: center;
    }

    .modal-content h2 {
      color: #667eea;
      margin-bottom: 16px;
    }

    .modal-content p {
      color: #6b7280;
      margin-bottom: 24px;
    }

    /* ===== APPROVAL WIZARD STYLES ===== */
    .wizard-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      padding: 20px;
    }

    .wizard-container {
      background: white;
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    }

    .wizard-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px 12px 0 0;
    }

    .wizard-progress {
      display: flex;
      justify-content: space-between;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.3);
    }

    .wizard-step {
      flex: 1;
      text-align: center;
      font-size: 12px;
      opacity: 0.5;
      transition: opacity 0.3s;
    }

    .wizard-step.active {
      opacity: 1;
      font-weight: 600;
    }

    .wizard-step.completed {
      opacity: 0.8;
    }

    .wizard-content {
      padding: 32px;
    }

    .wizard-content h2 {
      color: #1f2937;
      margin-bottom: 16px;
      font-size: 24px;
    }

    .wizard-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }

    .btn-approve {
      background: #10b981;
      color: white;
    }

    .btn-approve:hover:not(:disabled) {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-reject {
      background: #ef4444;
      color: white;
    }

    .btn-reject:hover:not(:disabled) {
      background: #dc2626;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== SCHEDULING WIDGET STYLES ===== */
    .scheduling-widget {
      margin: 20px 0;
    }

    .time-slot-btn {
      padding: 12px;
      margin: 8px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-block;
      min-width: 140px;
      text-align: center;
    }

    .time-slot-btn:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .time-slot-btn.selected {
      border-color: #667eea;
      background: #667eea;
      color: white;
      font-weight: 600;
    }

    .time-slot-btn.unavailable {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .time-slot-btn.unavailable:hover {
      border-color: #e5e7eb;
      background: white;
    }

    /* Approval Wizard Modal Styles */
    .wizard-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      overflow-y: auto;
      padding: 20px;
    }

    .wizard-modal-content {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
    }

    .wizard-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px 12px 0 0;
      text-align: center;
    }

    .wizard-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .wizard-close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }

    .wizard {
      padding: 40px;
    }

    .wizard-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .wizard-steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e5e7eb;
      z-index: 0;
    }

    .wizard-step {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 2px solid #e5e7eb;
      color: #9ca3af;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .wizard-step.active .step-number {
      background: #667eea;
      color: white;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
    }

    .wizard-step.completed .step-number {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .step-name {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }

    .wizard-step.active .step-name {
      color: #667eea;
      font-weight: 600;
    }

    .wizard-step.completed .step-name {
      color: #10b981;
    }

    .wizard-content {
      background: #f9fafb;
      padding: 30px;
      border-radius: 8px;
      min-height: 300px;
    }

    .wizard-content h2 {
      margin-bottom: 20px;
      color: #1f2937;
      font-size: 24px;
    }

    .wizard-actions {
      margin-top: 30px;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    .btn-wizard {
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }

    .btn-wizard-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-wizard-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }

    .btn-wizard-secondary {
      background: #e5e7eb;
      color: #4b5563;
    }

    .btn-wizard-secondary:hover {
      background: #d1d5db;
    }
  </style>
</head>
<body>
  <!-- Approval Wizard Modal -->
  <div id="wizard-modal" class="wizard-modal">
    <div class="wizard-modal-content">
      <div class="wizard-header">
        <button class="wizard-close" onclick="closeApprovalWizard()">&times;</button>
        <h1>Approve Your Quote</h1>
        <p>Let's get your project started!</p>
      </div>
      <div id="wizard-container"></div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <button class="signup-btn" onclick="showSignupModal()">🚀 Coming Soon: Marketplace Signup</button>
      <div id="company-info" style="display: none; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
      <h1>Your Project Dashboard</h1>
      <p id="customer-name">Loading...</p>
    </div>

    <div class="content">
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading your projects...</p>
      </div>

      <div id="error" class="error" style="display: none;"></div>

      <div id="portal-content" style="display: none;">
        <!-- Timeline -->
        <div class="timeline">
          <h3>📊 Project Timeline</h3>
          <div id="timeline-items"></div>
        </div>

        <!-- Projects -->
        <div id="projects-container"></div>
      </div>
    </div>
  </div>

  <!-- Coming Soon Modal -->
  <div id="signup-modal" class="coming-soon-modal">
    <div class="modal-content">
      <h2>🚀 Marketplace Coming Soon!</h2>
      <p>We're building a marketplace where you can offer your services to other contractors. Sign up to be notified when it launches!</p>
      <p style="font-size: 14px; color: #9ca3af;">For now, you can view and manage your projects without creating an account.</p>
      <button class="btn btn-primary" onclick="closeSignupModal()">Got it!</button>
    </div>
  </div>

  <!-- Approval Wizard Modal -->
  <div id="wizard-modal" class="wizard-modal">
    <div class="wizard-container">
      <div class="wizard-header">
        <h2 id="wizard-title">Approve Quote</h2>
        <div class="wizard-progress" id="wizard-progress"></div>
      </div>
      <div class="wizard-content" id="wizard-content"></div>
    </div>
  </div>

  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://cxlqzejzraczumqmsrcx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4bHF6ZWp6cmFjenVtcW1zcmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5ODU0NDMsImV4cCI6MjA3NDU2MTQ0M30.zoD59re6xxW9Z6HOexR0qwWwTBU29MvjwP_y8qwBkkg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =====================================================
    // STANDARDIZED MESSAGING ENUMS
    // =====================================================
    const MESSAGE_TYPES = {
      IN_APP: 'in_app',
      EMAIL: 'email',
      SMS: 'sms',
      SYSTEM: 'system'
    };

    const SENDER_TYPES = {
      CUSTOMER: 'customer',
      EMPLOYEE: 'employee',
      SYSTEM: 'system'
    };

    const DELIVERY_METHODS = {
      APP: 'app',
      EMAIL: 'email',
      SMS: 'sms',
      PUSH: 'push'
    };

    const MESSAGE_STATUS = {
      SENT: 'sent',
      DELIVERED: 'delivered',
      READ: 'read',
      FAILED: 'failed'
    };

    // Get customer token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const customerToken = urlParams.get('token');

    // Global state
    let customerData = null;
    let workOrders = [];
    let quoteData = null; // Current quote being approved
    let companySettings = null;
    let currentStep = 'review';
    let wizardSteps = [];
    let approvalData = {
      consent: false,
      signature: null,
      terms: false,
      depositMethod: null,
      scheduledTime: null,
      skipScheduling: false,
      paymentIntentId: null
    };
    let selectedSlot = null;
    let schedulingWidget = null;
    let stripe = null;
    let elements = null;
    let paymentElement = null;

    // Modal functions
    function showSignupModal() {
      document.getElementById('signup-modal').style.display = 'flex';
    }

    function closeSignupModal() {
      document.getElementById('signup-modal').style.display = 'none';
    }

    // Load customer portal
    async function loadPortal() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const portalContent = document.getElementById('portal-content');

      if (!customerToken) {
        loading.style.display = 'none';
        error.style.display = 'block';
        error.innerHTML = '❌ Invalid portal link. Please use the link from your email.';
        return;
      }

      try {
        console.log('🔍 Loading living quote data for token:', customerToken);
        console.log('📡 Calling RPC: get_living_quote_data');

        // Use new unified RPC for living quote data
        const { data: quoteData, error: quoteError } = await supabase
          .rpc('get_living_quote_data', { p_token: customerToken });

        console.log('📊 RPC Response:', { data: quoteData, error: quoteError });

        if (quoteError) {
          console.error('❌ RPC Error Details:', {
            message: quoteError.message,
            details: quoteError.details,
            hint: quoteError.hint,
            code: quoteError.code
          });
          throw quoteError;
        }

        if (!quoteData) {
          console.error('❌ No data returned from RPC');
          throw new Error('No data returned from server');
        }

        console.log('📦 Quote Data Type:', typeof quoteData);
        console.log('📦 Quote Data:', JSON.stringify(quoteData, null, 2));

        if (quoteData.error) {
          console.error('❌ Server returned error:', quoteData.error);
          throw new Error(quoteData.error);
        }

        console.log('✅ Living quote data loaded successfully');

        // Debug: Log the structure we received
        console.log('📦 Data structure received:', {
          hasQuote: !!quoteData.quote,
          hasCustomer: !!quoteData.customer,
          hasItems: !!quoteData.items,
          hasLineItems: !!quoteData.line_items,
          hasInvoice: !!quoteData.invoice,
          hasMessages: !!quoteData.messages,
          hasFiles: !!quoteData.files,
          keys: Object.keys(quoteData)
        });

        // Extract data from unified response
        const quote = quoteData.quote;
        const customer = quoteData.customer;
        const company = quoteData.company;
        const items = quoteData.items || quoteData.line_items || [];
        const invoice = quoteData.invoice;
        const messages = quoteData.messages || [];
        const files = quoteData.files || [];
        const timeline = quoteData.timeline || [];

        // Validate required data
        if (!quote) {
          console.error('❌ Missing quote in response');
          throw new Error('Quote data not found in response');
        }
        if (!customer) {
          console.error('❌ Missing customer in response');
          throw new Error('Customer data not found in response');
        }

        console.log('📋 Extracted data:', {
          quoteNumber: quote.work_order_number,
          customerName: customer.name,
          companyName: company?.name,
          itemCount: items.length,
          hasInvoice: !!invoice,
          messageCount: messages.length,
          fileCount: files.length,
          timelineEvents: timeline.length
        });

        customerData = customer;

        // Display company info
        if (company) {
          displayCompanyInfo(company);
        }

        // Update customer name in header
        document.getElementById('customer-name').textContent =
          customer.name || customer.email;

        // Store work orders in expected format for backward compatibility
        workOrders = [quote];
        console.log('✅ Quote loaded:', quote.work_order_number);

        // Render portal with live data
        renderTimeline(timeline);
        renderProjects();
        renderQuoteDetails(quote, items, invoice);
        renderMessages(messages);
        renderFiles(files);
        renderActionButtons(quote, invoice);

        loading.style.display = 'none';
        portalContent.style.display = 'block';

        // Start live refresh (every 30 seconds)
        startLiveRefresh(customerToken);

      } catch (err) {
        console.error('❌ Error loading portal:', err);
        console.error('❌ Error type:', err.constructor.name);
        console.error('❌ Error message:', err.message);
        console.error('❌ Error stack:', err.stack);

        // More specific error messages
        let errorMessage = 'Link expired or invalid';
        let errorDetails = '';

        if (err.message.includes('not found')) {
          errorMessage = 'Quote not found';
          errorDetails = 'The link may have expired or the quote may have been deleted.';
        } else if (err.message.includes('expired')) {
          errorMessage = 'Link expired';
          errorDetails = 'Please request a new quote link from your service provider.';
        } else if (err.code === 'PGRST116') {
          errorMessage = 'System error';
          errorDetails = 'Database function not found. Please contact support.';
        } else if (err.message.includes('Quote data not found')) {
          errorMessage = 'Invalid response';
          errorDetails = 'The server returned an unexpected response. Please try again or contact support.';
        } else if (err.message) {
          errorMessage = err.message;
        }

        loading.style.display = 'none';
        error.style.display = 'block';
        error.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <h2 style="color: #dc3545; margin-bottom: 10px;">❌ ${errorMessage}</h2>
            ${errorDetails ? `<p style="color: #6c757d; margin-bottom: 20px;">${errorDetails}</p>` : ''}
            <p style="color: #6c757d; font-size: 14px;">
              Token: <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">${customerToken}</code>
            </p>
          </div>
        `;
      }
    }

    // Render timeline
    function renderTimeline(timelineData = []) {
      const container = document.getElementById('timeline-items');

      // Use timeline data from RPC if available, otherwise build from work orders
      let events = [];
      let currentStatus = (workOrders && workOrders[0] && workOrders[0].status) || null;

      if (timelineData && timelineData.length > 0) {
        // Use timeline from RPC (be tolerant to different field names)
        events = timelineData
          .map(item => {
            const date = item.timestamp || item.time || item.created_at || item.date || item.occurred_at || null;
            const label = item.description || item.event || item.label || item.title || item.name || null;
            return { date, label, status: 'completed' };
          })
          // Filter out entries with no label to avoid "undefined"
          .filter(e => !!e.label);
      } else {
        // Fallback: Build timeline from work orders
        workOrders.forEach(wo => {
          currentStatus = wo.status; // Track current status

          if (wo.quote_sent_at) {
            events.push({ date: wo.quote_sent_at, label: 'Quote sent to customer', status: 'completed', order: wo });
          }
          if (wo.quote_viewed_at || wo.viewed_at) {
            events.push({ date: wo.quote_viewed_at || wo.viewed_at, label: 'Customer viewed quote', status: 'completed', order: wo });
          }
          if (wo.quote_accepted_at || wo.approved_at) {
            events.push({ date: wo.quote_accepted_at || wo.approved_at, label: 'Quote approved by customer', status: 'completed', order: wo });
          }
          if (wo.scheduled_start) {
            const isPast = new Date(wo.scheduled_start) < new Date();
            events.push({
              date: wo.scheduled_start,
              label: 'Job scheduled',
              status: isPast ? 'completed' : 'in-progress',
              order: wo
            });
          }
          if (wo.actual_start) {
            events.push({ date: wo.actual_start, label: 'Job started', status: 'completed', order: wo });
          }
          if (wo.actual_end || wo.completed_at) {
            events.push({ date: wo.actual_end || wo.completed_at, label: 'Job completed', status: 'completed', order: wo });
          }
          if (wo.invoice_sent_at) {
            events.push({ date: wo.invoice_sent_at, label: 'Invoice sent', status: 'completed', order: wo });
          }
          if (wo.paid_at) {
            events.push({ date: wo.paid_at, label: 'Payment received', status: 'completed', order: wo });
          }
        });
      }

      // If RPC timeline produced no valid events, fallback to work orders
      if (events.length === 0 && workOrders && workOrders.length > 0) {
        workOrders.forEach(wo => {
          currentStatus = wo.status;
          if (wo.quote_sent_at) {
            events.push({ date: wo.quote_sent_at, label: 'Quote sent to customer', status: 'completed', order: wo });
          }
          if (wo.quote_viewed_at || wo.viewed_at) {
            events.push({ date: wo.quote_viewed_at || wo.viewed_at, label: 'Customer viewed quote', status: 'completed', order: wo });
          }
          if (wo.quote_accepted_at || wo.approved_at) {
            events.push({ date: wo.quote_accepted_at || wo.approved_at, label: 'Quote approved by customer', status: 'completed', order: wo });
          }
          if (wo.scheduled_start) {
            const isPast = new Date(wo.scheduled_start) < new Date();
            events.push({
              date: wo.scheduled_start,
              label: 'Job scheduled',
              status: isPast ? 'completed' : 'in-progress',
              order: wo
            });
          }
          if (wo.actual_start) {
            events.push({ date: wo.actual_start, label: 'Job started', status: 'completed', order: wo });
          }
          if (wo.actual_end || wo.completed_at) {
            events.push({ date: wo.actual_end || wo.completed_at, label: 'Job completed', status: 'completed', order: wo });
          }
          if (wo.invoice_sent_at) {
            events.push({ date: wo.invoice_sent_at, label: 'Invoice sent', status: 'completed', order: wo });
          }
          if (wo.paid_at) {
            events.push({ date: wo.paid_at, label: 'Payment received', status: 'completed', order: wo });
          }
        });
      }


      // Sort by date
      events.sort((a, b) => new Date(a.date) - new Date(b.date));

      if (events.length === 0) {
        container.innerHTML = '<p style="color: #6b7280;">No activity yet</p>';
        return;
      }

      // Determine next step based on current status
      let nextStep = null;
      if (currentStatus === 'sent' || currentStatus === 'viewed') {
        nextStep = '⏳ Awaiting your approval';
      } else if (currentStatus === 'approved') {
        nextStep = '⏳ Awaiting scheduling';
      } else if (currentStatus === 'scheduled') {
        nextStep = '⏳ Awaiting job start';
      } else if (currentStatus === 'in_progress') {
        nextStep = '⏳ Job in progress';
      } else if (currentStatus === 'completed') {
        nextStep = '⏳ Awaiting invoice';
      } else if (currentStatus === 'invoiced') {
        nextStep = '⏳ Awaiting payment';
      }

      let html = '';
      events.forEach(event => {
        const icon = event.status === 'completed' ? '✓' : '●';
        const dateText = formatDate(event.date);
        html += `
          <div class="timeline-item">
            <div class="timeline-icon ${event.status}">${icon}</div>
            <div class="timeline-content">
              <div class="timeline-title">${event.label}</div>
              ${dateText ? `<div class="timeline-date">${dateText}</div>` : ''}
            </div>
          </div>
        `;
      });

      // Add next step indicator
      if (nextStep) {
        html += `
          <div class="timeline-item">
            <div class="timeline-icon in-progress">●</div>
            <div class="timeline-content">
              <div class="timeline-title" style="color: #667eea; font-weight: 600;">${nextStep}</div>
              <div class="timeline-date" style="color: #9ca3af;">Next step</div>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    // Render projects
    function renderProjects() {
      const container = document.getElementById('projects-container');

      if (workOrders.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 40px;">No projects yet</p>';
        return;
      }

      let html = '';
      workOrders.forEach(wo => {
        const statusBadge = getStatusBadge(wo);
        const stage = getProjectStage(wo);

        html += `
          <div class="project-card">
            <div class="project-header">
              <div class="project-title">${wo.title || 'Untitled Project'}</div>
              ${statusBadge}
            </div>

            <p style="color: #6b7280; margin-bottom: 16px;">${wo.description || 'No description'}</p>

            <div class="project-details">
              <div class="detail-item">
                <div class="detail-label">Project #</div>
                <div class="detail-value">${wo.quote_number || wo.work_order_number || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Total Amount</div>
                <div class="detail-value">$${(wo.total_amount || 0).toFixed(2)}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Stage</div>
                <div class="detail-value">${stage}</div>
              </div>
              ${wo.scheduled_start ? `
                <div class="detail-item">
                  <div class="detail-label">Scheduled</div>
                  <div class="detail-value">${formatDate(wo.scheduled_start)}</div>
                </div>
              ` : ''}
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
              ${getActionButtons(wo)}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Get status badge HTML
    function getStatusBadge(wo) {
      if (wo.paid_at) {
        return '<span class="status-badge paid">✓ Paid</span>';
      }
      if (wo.invoice_sent_at) {
        return '<span class="status-badge pending">⏳ Invoice Sent</span>';
      }
      if (wo.actual_end || wo.completed_at) {
        return '<span class="status-badge completed">✓ Completed</span>';
      }
      if (wo.actual_start) {
        return '<span class="status-badge in-progress">🔧 In Progress</span>';
      }
      if (wo.scheduled_start) {
        return '<span class="status-badge approved">📅 Scheduled</span>';
      }
      if (wo.quote_accepted_at) {
        return '<span class="status-badge approved">✓ Approved</span>';
      }
      if (wo.quote_sent_at) {
        return '<span class="status-badge pending">⏳ Quote Sent</span>';
      }
      return '<span class="status-badge pending">Draft</span>';
    }

    // Get project stage
    function getProjectStage(wo) {
      if (wo.paid_at) return 'Paid';
      if (wo.invoice_sent_at) return 'Invoiced';
      if (wo.actual_end || wo.completed_at) return 'Completed';
      if (wo.actual_start) return 'In Progress';
      if (wo.scheduled_start) return 'Scheduled';
      if (wo.quote_accepted_at) return 'Approved';
      if (wo.quote_sent_at) return 'Quote';
      return 'Draft';
    }

    // Get action buttons (removed - buttons now rendered separately)
    function getActionButtons(wo) {
      return ''; // Buttons moved to bottom of page
    }

    // Format date (returns empty string if invalid)
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return '';
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Display company info
    function displayCompanyInfo(company) {
      console.log('🏢 displayCompanyInfo called with:', company);
      const container = document.getElementById('company-info');
      console.log('📦 Container element:', container);

      if (!company || !company.name) {
        console.log('⚠️ No company data or name, hiding container');
        if (container) container.style.display = 'none';
        return;
      }

      console.log('✅ Displaying company:', company.name);
      container.style.display = 'block';
      container.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
          ${company.logo_url ? `
            <img src="${company.logo_url}" alt="${company.name}" style="height: 50px; width: auto; border-radius: 4px;">
          ` : ''}
          <div style="flex: 1;">
            <h3 style="margin: 0 0 5px 0; color: #1f2937; font-size: 18px;">${company.name}</h3>
            <div style="display: flex; gap: 15px; font-size: 14px; color: #6b7280;">
              ${company.phone ? `<span>📞 ${company.phone}</span>` : ''}
              ${company.email ? `<span>✉️ ${company.email}</span>` : ''}
              ${company.website ? `<span>🌐 <a href="${company.website}" target="_blank" style="color: #667eea;">${company.website}</a></span>` : ''}
            </div>
            ${company.address_line1 ? `
              <div style="font-size: 13px; color: #9ca3af; margin-top: 5px;">
                📍 ${company.address_line1}${company.city ? `, ${company.city}` : ''}${company.state_province ? `, ${company.state_province}` : ''}${company.postal_code ? ` ${company.postal_code}` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Render action buttons at bottom of page
    function renderActionButtons(quote, invoice) {
      let actionsSection = document.getElementById('actions-section');
      if (!actionsSection) {
        actionsSection = document.createElement('div');
        actionsSection.id = 'actions-section';
        actionsSection.style.cssText = `
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: white;
          padding: 20px;
          box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
          display: flex;
          justify-content: center;
          gap: 15px;
          z-index: 1000;
        `;
        document.body.appendChild(actionsSection);
      }

      let buttons = '';

      // Approve quote button (if quote sent but not approved)
      if (quote.quote_sent_at && !quote.quote_accepted_at && !quote.quote_rejected_at) {
        buttons += `
          <button onclick="openApprovalWizard()" style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 48px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';">
            ✅ Approve Quote
          </button>
        `;
      }

      // Pay invoice button (if invoice sent but not paid)
      if (invoice && invoice.sent_at && !invoice.paid_at) {
        buttons += `
          <button onclick="payInvoice('${quote.id}')" style="
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 16px 48px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)';">
            💳 Pay Invoice
          </button>
        `;
      }

      if (buttons) {
        actionsSection.innerHTML = buttons;
        actionsSection.style.display = 'flex';
      } else {
        actionsSection.style.display = 'none';
      }
    }

    // ========================================
    // APPROVAL WIZARD
    // ========================================

    // Wizard state variables (reuse existing global variables)
    let currentStepIndex = 0;

    // Action handlers
    function openApprovalWizard() {
      console.log('🎯 Opening approval wizard...');
      // Reset approval data
      approvalData = {
        consent: false,
        signature: null,
        terms: false,
        depositMethod: null,
        scheduledTime: null,
        skipScheduling: false
      };
      currentStepIndex = 0;
      showApprovalWizard();
    }

    function closeApprovalWizard() {
      document.getElementById('wizard-modal').style.display = 'none';
      approvalData = {
        consent: false,
        signature: null,
        terms: false,
        depositMethod: null,
        scheduledTime: null,
        skipScheduling: false
      };
      currentStepIndex = 0;
    }

    async function showApprovalWizard() {
      // Get the current quote from workOrders
      quoteData = workOrders && workOrders.length > 0 ? workOrders[0] : null;
      if (!quoteData) {
        alert('Quote data not found. Please refresh the page.');
        return;
      }

      console.log('📋 Starting approval wizard for quote:', quoteData.work_order_number);

      // Determine wizard steps based on quote settings
      wizardSteps = ['review'];

      // Check if deposit is required
      if (quoteData.deposit_required) {
        console.log('💰 Deposit required');
        wizardSteps.push('deposit');
      }

      // Check if customer can schedule
      const schedulingMode = quoteData.scheduling_mode || 'customer_choice';
      if (schedulingMode === 'customer_choice' || schedulingMode === 'custom_schedule') {
        console.log('📅 Customer can schedule');
        wizardSteps.push('schedule');
      } else if (schedulingMode === 'company_schedules') {
        console.log('📞 Company will schedule');
        approvalData.skipScheduling = true;
      }

      wizardSteps.push('confirmation');

      console.log('✅ Wizard steps:', wizardSteps);

      // Show modal
      document.getElementById('wizard-modal').style.display = 'block';
      renderWizard();
    }

    function renderWizard() {
      const container = document.getElementById('wizard-container');
      const currentStep = wizardSteps[currentStepIndex];

      container.innerHTML = `
        <div class="wizard">
          <div class="wizard-steps">
            ${wizardSteps.map((step, index) => `
              <div class="wizard-step ${index === currentStepIndex ? 'active' : ''} ${index < currentStepIndex ? 'completed' : ''}">
                <div class="step-number">${index + 1}</div>
                <div class="step-name">${getStepName(step)}</div>
              </div>
            `).join('')}
          </div>
          <div class="wizard-content">
            ${getStepContent(currentStep)}
          </div>
        </div>
      `;

      // Initialize step-specific functionality
      initializeStep(currentStep);
    }

    function getStepName(step) {
      const names = {
        'review': 'Review',
        'deposit': 'Deposit',
        'schedule': 'Schedule',
        'confirmation': 'Complete'
      };
      return names[step] || step;
    }

    function getStepContent(step) {
      switch(step) {
        case 'review':
          return getReviewStepContent();
        case 'deposit':
          return getDepositStepContent();
        case 'schedule':
          return getScheduleStepContent();
        case 'confirmation':
          return getConfirmationStepContent();
        default:
          return '<p>Unknown step</p>';
      }
    }

    function getReviewStepContent() {
      return `
        <h2>📋 Review Your Quote</h2>
        <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span style="font-weight: 600;">Quote Number:</span>
            <span>${quoteData.quote_number || quoteData.work_order_number}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span style="font-weight: 600;">Project:</span>
            <span>${quoteData.title || 'Untitled'}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
            <span style="font-weight: 600; font-size: 18px;">Total Amount:</span>
            <span style="font-weight: 700; font-size: 18px; color: #667eea;">$${(quoteData.total_amount || 0).toFixed(2)}</span>
          </div>
        </div>

        <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px; margin: 20px 0;">
          <label style="display: flex; align-items: start; cursor: pointer;">
            <input type="checkbox" id="consent-checkbox" style="margin-right: 12px; margin-top: 4px; width: 18px; height: 18px;">
            <span style="color: #1e40af; font-size: 14px;">
              I have reviewed the quote details and agree to proceed with this project. I understand the scope of work and the total cost.
            </span>
          </label>
        </div>

        <div class="wizard-actions">
          <button class="btn-wizard btn-wizard-secondary" onclick="closeApprovalWizard()">Cancel</button>
          <button class="btn-wizard btn-wizard-primary" id="review-next-btn" onclick="nextStep()" disabled>Continue</button>
        </div>
      `;
    }

    function getDepositStepContent() {
      const depositAmount = quoteData.deposit_amount || 0;
      const allowedMethods = quoteData.allowed_payment_methods || ['online', 'cash', 'check'];

      return `
        <h2>💰 Deposit Payment</h2>
        <p style="margin-bottom: 20px;">A deposit of <strong>$${depositAmount.toFixed(2)}</strong> is required to proceed.</p>

        <div style="background: white; padding: 20px; border-radius: 8px;">
          <p style="font-weight: 600; margin-bottom: 15px;">How would you like to pay the deposit?</p>

          ${allowedMethods.includes('online') ? `
            <label style="display: block; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
              <input type="radio" name="deposit-method" value="online" style="margin-right: 10px;" onchange="selectDepositMethod('online')">
              <strong>💳 Pay Online Now</strong>
              <div style="font-size: 14px; color: #6b7280; margin-top: 5px; margin-left: 24px;">Secure payment via credit/debit card</div>
            </label>
          ` : ''}

          ${allowedMethods.includes('cash') ? `
            <label style="display: block; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
              <input type="radio" name="deposit-method" value="cash" style="margin-right: 10px;" onchange="selectDepositMethod('cash')">
              <strong>💵 Pay Cash on Arrival</strong>
              <div style="font-size: 14px; color: #6b7280; margin-top: 5px; margin-left: 24px;">Pay when technician arrives</div>
            </label>
          ` : ''}

          ${allowedMethods.includes('check') ? `
            <label style="display: block; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
              <input type="radio" name="deposit-method" value="check" style="margin-right: 10px;" onchange="selectDepositMethod('check')">
              <strong>🏦 Pay by Check on Arrival</strong>
              <div style="font-size: 14px; color: #6b7280; margin-top: 5px; margin-left: 24px;">Pay when technician arrives</div>
            </label>
          ` : ''}

          <label style="display: block; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
            <input type="radio" name="deposit-method" value="prepaid" style="margin-right: 10px;" onchange="selectDepositMethod('prepaid')">
            <strong>✅ Already Paid</strong>
            <div style="font-size: 14px; color: #6b7280; margin-top: 5px; margin-left: 24px;">I've already paid the deposit</div>
          </label>
        </div>

        <div class="wizard-actions">
          <button class="btn-wizard btn-wizard-secondary" onclick="previousStep()">Back</button>
          <button class="btn-wizard btn-wizard-primary" id="deposit-next-btn" onclick="nextStep()" disabled>Continue</button>
        </div>
      `;
    }

    function getScheduleStepContent() {
      return `
        <h2>📅 Schedule Your Service</h2>
        <p style="margin-bottom: 20px;">When would you like us to start your project?</p>

        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <p style="font-weight: 600; margin-bottom: 15px;">Choose an option:</p>

          <label style="display: block; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; cursor: pointer;" onclick="selectScheduleOption('asap')">
            <input type="radio" name="schedule-option" value="asap" style="margin-right: 10px;">
            <strong>⚡ As Soon As Possible</strong>
            <div style="font-size: 14px; color: #6b7280; margin-top: 5px; margin-left: 24px;">We'll schedule the earliest available slot</div>
          </label>

          <label style="display: block; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onclick="selectScheduleOption('call')">
            <input type="radio" name="schedule-option" value="call" style="margin-right: 10px;">
            <strong>📞 Call Me to Schedule</strong>
            <div style="font-size: 14px; color: #6b7280; margin-top: 5px; margin-left: 24px;">We'll contact you within 1 business day</div>
          </label>
        </div>

        <div class="wizard-actions">
          <button class="btn-wizard btn-wizard-secondary" onclick="previousStep()">Back</button>
          <button class="btn-wizard btn-wizard-primary" id="schedule-next-btn" onclick="nextStep()" disabled>Continue</button>
        </div>
      `;
    }

    function getConfirmationStepContent() {
      let scheduleInfo = '';
      if (approvalData.scheduledTime === 'asap') {
        scheduleInfo = `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">⚡ Scheduled ASAP</div>
            <div style="font-size: 16px;">We'll contact you with the earliest available time slot.</div>
          </div>
        `;
      } else if (approvalData.scheduledTime === 'call' || approvalData.skipScheduling) {
        scheduleInfo = `
          <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">📞 We'll Contact You</div>
            <div style="font-size: 16px;">Our team will call you within 1 business day to schedule a convenient time.</div>
          </div>
        `;
      }

      let depositInfo = '';
      if (approvalData.depositMethod) {
        const depositAmount = quoteData.deposit_amount || 0;
        const methodLabels = {
          'online': '💳 Online Payment',
          'cash': '💵 Cash (on arrival)',
          'check': '🏦 Check (on arrival)',
          'prepaid': '✅ Already Paid'
        };

        depositInfo = `
          <div style="background: #fff7ed; border-left: 4px solid #f59e0b; padding: 16px; margin: 16px 0;">
            <div style="font-weight: 600; color: #92400e;">Deposit: $${depositAmount.toFixed(2)}</div>
            <div style="color: #92400e; font-size: 14px; margin-top: 4px;">Payment method: ${methodLabels[approvalData.depositMethod]}</div>
          </div>
        `;
      }

      return `
        <h2>🎉 All Set!</h2>
        <p style="margin: 20px 0; font-size: 18px;">Your quote has been approved successfully!</p>

        ${scheduleInfo}
        ${depositInfo}

        <div style="background: #f0fdf4; border-left: 4px solid #22c55e; padding: 20px; margin: 20px 0;">
          <strong>What happens next?</strong>
          <ul style="margin: 10px 0 0 20px;">
            <li>We'll send you a confirmation email</li>
            <li>Our team will contact you to finalize details</li>
            <li>We'll get started on your project!</li>
          </ul>
        </div>

        <div class="wizard-actions">
          <button class="btn-wizard btn-wizard-primary" onclick="finalizeApproval()" style="width: 100%;">Confirm & Finish</button>
        </div>
      `;
    }

    function initializeStep(step) {
      if (step === 'review') {
        const checkbox = document.getElementById('consent-checkbox');
        const nextBtn = document.getElementById('review-next-btn');
        if (checkbox && nextBtn) {
          checkbox.addEventListener('change', function() {
            approvalData.consent = this.checked;
            nextBtn.disabled = !this.checked;
          });
        }
      }
    }

    function selectDepositMethod(method) {
      approvalData.depositMethod = method;
      const nextBtn = document.getElementById('deposit-next-btn');
      if (nextBtn) nextBtn.disabled = false;
      console.log('💰 Deposit method selected:', method);
    }

    function selectScheduleOption(option) {
      approvalData.scheduledTime = option;
      const nextBtn = document.getElementById('schedule-next-btn');
      if (nextBtn) nextBtn.disabled = false;
      console.log('📅 Schedule option selected:', option);
    }

    function nextStep() {
      if (currentStepIndex < wizardSteps.length - 1) {
        currentStepIndex++;
        renderWizard();
      }
    }

    function previousStep() {
      if (currentStepIndex > 0) {
        currentStepIndex--;
        renderWizard();
      }
    }

    async function finalizeApproval() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        console.log('✅ Finalizing approval with data:', approvalData);

        // Call RPC to approve quote
        const { data, error } = await supabase.rpc('approve_quote', {
          quote_id: quoteData.id,
          new_status: 'approved'
        });

        if (error) throw error;

        console.log('✅ Quote approved successfully!', data);

        // Show success message
        document.getElementById('wizard-container').innerHTML = `
          <div style="text-align: center; padding: 60px 40px;">
            <div style="font-size: 80px; margin-bottom: 20px;">✅</div>
            <h2 style="color: #10b981; margin-bottom: 20px; font-size: 32px;">Quote Approved!</h2>
            <p style="font-size: 18px; color: #6b7280; margin-bottom: 30px;">Thank you for approving your quote. We're excited to work with you!</p>
            <button class="btn-wizard btn-wizard-primary" onclick="closeApprovalWizard(); location.reload();">Close</button>
          </div>
        `;

      } catch (error) {
        console.error('❌ Error approving quote:', error);
        alert('Error approving quote: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Confirm & Finish';
      }
    }

    function payInvoice(workOrderId) {
      // TODO: Open invoice payment modal
      alert('Payment processing coming soon! For now, please contact us to make a payment.');
    }

    // =====================================================
    // LIVING QUOTE LINK - LIVE REFRESH SYSTEM
    // =====================================================
    let refreshInterval = null;
    let lastRefreshTime = null;

    async function startLiveRefresh(token) {
      console.log('🔄 Starting live refresh (every 30 seconds)...');

      // Refresh immediately, then every 30 seconds
      refreshInterval = setInterval(async () => {
        await refreshLivingQuoteData(token);
      }, 30000);
    }

    async function refreshLivingQuoteData(token) {
      try {
        const { data: quoteData, error } = await supabase
          .rpc('get_living_quote_data', { p_token: token });

        if (error) {
          console.error('❌ Refresh error:', error);
          return;
        }

        if (!quoteData || quoteData.error) {
          console.warn('⚠️ Quote link expired or invalid');
          clearInterval(refreshInterval);
          showExpiredLinkMessage();
          return;
        }

        const quote = quoteData.quote;
        const items = quoteData.items || [];
        const invoice = quoteData.invoice;
        const messages = quoteData.messages || [];
        const files = quoteData.files || [];

        // Update work orders
        workOrders = [quote];

        // Re-render with updated data
        renderTimeline();
        renderProjects();
        renderQuoteDetails(quote, items, invoice);
        renderMessages(messages);
        renderFiles(files);

        lastRefreshTime = new Date();
        console.log('✅ Live data refreshed at', lastRefreshTime.toLocaleTimeString());

      } catch (err) {
        console.error('❌ Refresh failed:', err);
      }
    }

    function showExpiredLinkMessage() {
      const content = document.getElementById('portal-content');
      if (content) {
        content.innerHTML = `
          <div style="text-align: center; padding: 60px 20px;">
            <h2 style="color: #dc2626; margin-bottom: 20px;">Link Expired</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">
              This quote link has expired. Please contact the service provider for a new link.
            </p>
            <button onclick="location.reload()" style="
              background: #667eea;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
            ">Refresh Page</button>
          </div>
        `;
      }
    }

    // =====================================================
    // HELPER FUNCTIONS FOR RENDERING QUOTE DETAILS
    // =====================================================

    function renderQuoteDetails(quote, items, invoice) {
      // Create or update quote details section
      let detailsSection = document.getElementById('quote-details-section');
      if (!detailsSection) {
        detailsSection = document.createElement('div');
        detailsSection.id = 'quote-details-section';
        detailsSection.style.marginTop = '30px';
        document.getElementById('portal-content').appendChild(detailsSection);
      }

      const statusColor = {
        'quote': '#3b82f6',
        'approved': '#10b981',
        'scheduled': '#f59e0b',
        'in_progress': '#8b5cf6',
        'completed': '#10b981',
        'invoiced': '#3b82f6',
        'paid': '#10b981',
        'closed': '#6b7280'
      };

      detailsSection.innerHTML = `
        <div style="background: #f9fafb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 15px; color: #1f2937;">Quote Details</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <p style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Quote Number</p>
              <p style="font-weight: 600; color: #1f2937;">${quote.work_order_number}</p>
            </div>
            <div>
              <p style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Status</p>
              <p style="font-weight: 600; color: white; background: ${statusColor[quote.status] || '#6b7280'}; padding: 4px 8px; border-radius: 4px; display: inline-block; font-size: 12px;">
                ${quote.status.toUpperCase()}
              </p>
            </div>
            <div>
              <p style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Total Amount</p>
              <p style="font-weight: 600; color: #1f2937;">$${(quote.total_amount || 0).toFixed(2)}</p>
            </div>
            <div>
              <p style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Created</p>
              <p style="font-weight: 600; color: #1f2937;">${new Date(quote.created_at).toLocaleDateString()}</p>
            </div>
          </div>

          ${items.length > 0 ? `
            <div style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding-top: 15px;">
              <h4 style="margin-bottom: 10px; color: #1f2937;">Line Items</h4>
              <table style="width: 100%; font-size: 14px;">
                <thead>
                  <tr style="border-bottom: 1px solid #e5e7eb;">
                    <th style="text-align: left; padding: 8px; color: #6b7280;">Description</th>
                    <th style="text-align: right; padding: 8px; color: #6b7280;">Qty</th>
                    <th style="text-align: right; padding: 8px; color: #6b7280;">Price</th>
                    <th style="text-align: right; padding: 8px; color: #6b7280;">Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${items.map(item => `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                      <td style="padding: 8px; color: #1f2937;">${item.description}</td>
                      <td style="text-align: right; padding: 8px; color: #1f2937;">${item.quantity}</td>
                      <td style="text-align: right; padding: 8px; color: #1f2937;">$${(item.unit_price || 0).toFixed(2)}</td>
                      <td style="text-align: right; padding: 8px; color: #1f2937; font-weight: 600;">$${(item.total_price || 0).toFixed(2)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}

          ${invoice ? `
            <div style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding-top: 15px; background: #f0fdf4; padding: 15px; border-radius: 6px;">
              <h4 style="margin-bottom: 10px; color: #15803d;">Invoice</h4>
              <p style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Invoice Number</p>
              <p style="font-weight: 600; color: #1f2937; margin-bottom: 10px;">${invoice.invoice_number}</p>
              <p style="color: #6b7280; font-size: 12px; margin-bottom: 5px;">Amount Due</p>
              <p style="font-weight: 600; color: #1f2937; margin-bottom: 10px;">$${(invoice.amount_due || 0).toFixed(2)}</p>
              ${invoice.paid_at ? `
                <p style="color: #10b981; font-weight: 600;">✅ Paid on ${new Date(invoice.paid_at).toLocaleDateString()}</p>
              ` : `
                <button onclick="payInvoice('${quote.id}')" style="
                  background: #667eea;
                  color: white;
                  border: none;
                  padding: 8px 16px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                ">Pay Now</button>
              `}
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderMessages(messages) {
      let messagesSection = document.getElementById('messages-section');
      if (!messagesSection) {
        messagesSection = document.createElement('div');
        messagesSection.id = 'messages-section';
        messagesSection.style.marginTop = '30px';
        document.getElementById('portal-content').appendChild(messagesSection);
      }

      messagesSection.innerHTML = `
        <div class="section-block glass">
          <div class="section-title">
            <span>Updates & Messages</span>
            <span class="badge">${messages.length}</span>
          </div>

          <!-- Message List -->
          <div id="message-list" class="message-list">
            ${messages.length === 0 ? '<p class="empty-hint">No messages yet. Send a message below to get started!</p>' : messages.map(msg => `
              <div class="message-bubble ${msg.sender_type === SENDER_TYPES.CUSTOMER ? 'customer' : 'company'}">
                <div class="message-header">
                  <span class="sender-name">${msg.sender_name || (msg.sender_type === SENDER_TYPES.CUSTOMER ? 'You' : 'Company')}</span>
                  <span class="message-time">${new Date(msg.created_at).toLocaleString()}</span>
                </div>
                <div class="message-content">${msg.message_text || msg.content || msg.message || ''}</div>
              </div>
            `).join('')}
          </div>

          <!-- Send Message Form -->
          <div class="message-compose card">
            <h4 class="compose-title">Send a Message</h4>
            <form id="send-message-form" onsubmit="sendMessage(event)">
              <textarea
                id="message-input"
                class="textarea-modern"
                placeholder="Type your message here..."
                required
              ></textarea>
              <div class="compose-actions">
                <p class="compose-hint">We'll respond as soon as possible</p>
                <button
                  type="submit"
                  id="send-message-btn"
                  class="btn-modern"
                >
                  Send Message
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    async function sendMessage(event) {
      event.preventDefault();

      const messageInput = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-message-btn');
      const messageText = messageInput.value.trim();

      if (!messageText) return;

      // Disable form while sending
      messageInput.disabled = true;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        console.log('📤 Sending message...');

        const workOrder = workOrders && workOrders.length > 0 ? workOrders[0] : null;
        if (!workOrder) {
          throw new Error('Work order not found');
        }

        console.log('📋 Work order data:', { id: workOrder.id, customer_id: workOrder.customer_id, token: customerToken });

        // Call RPC function to send message
        const { data, error } = await supabase.rpc('send_portal_message', {
          p_customer_id: workOrder.customer_id,
          p_portal_token: customerToken,
          p_work_order_id: workOrder.id,
          p_content: messageText
        });

        if (error) throw error;

        console.log('✅ Message sent successfully!', data);

        // Clear input
        messageInput.value = '';

        // Reload portal data to show new message
        await refreshLivingQuoteData(customerToken);

        // Show success message
        alert('✅ Message sent successfully!');

      } catch (error) {
        console.error('❌ Error sending message:', error);
        alert('Failed to send message: ' + error.message);
      } finally {
        // Re-enable form
        messageInput.disabled = false;
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Message';
      }
    }

    function renderFiles(files) {
      let filesSection = document.getElementById('files-section');
      if (!filesSection) {
        filesSection = document.createElement('div');
        filesSection.id = 'files-section';
        filesSection.style.marginTop = '30px';
        document.getElementById('portal-content').appendChild(filesSection);
      }

      if (files.length === 0) {
        filesSection.innerHTML = '';
        return;
      }

      filesSection.innerHTML = `
        <div style="background: #f9fafb; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; color: #1f2937;">Files & Attachments</h3>
          ${files.map(file => {
            // Construct proper Supabase Storage public URL
            const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/files/${file.file_url}`;
            console.log('📎 File URL:', file.file_name, '→', publicUrl);

            return `
              <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <p style="font-weight: 600; color: #1f2937; margin-bottom: 5px;">${file.file_name}</p>
                  <p style="color: #9ca3af; font-size: 12px;">${new Date(file.uploaded_at).toLocaleDateString()}</p>
                </div>
                <a href="${publicUrl}" target="_blank" style="
                  background: #667eea;
                  color: white;
                  padding: 6px 12px;
                  border-radius: 4px;
                  text-decoration: none;
                  font-size: 12px;
                ">Download</a>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Load portal on page load
    loadPortal();
  </script>
</body>
</html>
